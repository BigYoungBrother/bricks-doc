# JVM

## JVM运行机制

![JVM运行机制和运行时数据区](./images/jvm内存概览.png)

JVM是用于运行Java字节码的虚拟机，包括字节码指令集、程序寄存器、虚拟机栈、虚拟机堆、方法区和垃圾回收器。JVM屏蔽了操作系统的差异，能够跨平台运行，其运行在操作系统之上，不与硬件系统直接交互。

Java源文件(.java)在通过编译器之后被编译成相应的字节码文件(.class)，字节码文件又被JVM中的解释器编译成机器码后在操作系统上运行。每种操作系统的解释器都是不同的。

如上图所示，JVM包括一个类加载器子系统、运行时数据区、执行引擎和本地接口库。本地接口库通过调用本地方法库与操作系统交互。

下面我们将依次说明对JVM各组成部分的关键知识点

## JVM的内存区域

JVM的内存区域分为线程私有（虚拟机栈、程序计数器、本地方法栈），线程共享（堆、方法区）和直接内存

- 线程私有区域的生命周期与线程相同，每个线程都与操作系统的本地线程直接映射。
- 线程共享区域随虚拟机的启动而创建，随虚拟的关闭而销毁。
- 直接内存也叫做堆外内存、其并不是JVM运行时数据区的一部分，但是JVM内存区域的重要组成部分。Java通过堆外内存避免在Java堆和Native堆中来回复制数据带来的资源浪费和性能消耗，因此堆外内存在高并发应用场景下被广泛使用(JavaNIO, Netty)

### 程序计数器

程序计数器是一块较小的内存空间，可以看作是当前线程所执行的字节码的行号指示器。字节码解释器工作时通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等功能都需要依赖这个计数器来完成。

如果该方法执行的是native方法，那么程序计数器的值为空(Undefined)

程序计数器属于线程私有的内存区域，唯一一个没有内存溢出(Out Of Memory)的区域

程序计数器主要有两个作用：
- 字节码解释器通过改变程序计数器来依次读取指令，从而实现代码的流程控制，如：顺序执行、选择、循环、异常处理。
- 在多线程的情况下，程序计数器用于记录当前线程执行的位置，从而当线程被切换回来的时候能够知道该线程上次运行到哪儿了。

### 虚拟机栈

虚拟机栈是描述Java方法的执行过程的内存模型，由栈帧组成。当前栈帧中存储了本地变量表，操作数栈、动态链接和方法出口等信息。同时栈帧用来存储部分运行时数据及其数据结构，处理动态链接方法的返回值和异常分发。

栈帧用来记录方法的执行过程，在方法被执行时虚拟机会为其创建一个与之对应的栈帧，方法的执行和返回对应栈帧在虚拟机栈中的入栈和出栈，每个运行中的线程只有一个栈帧处于活动状态。

Java 方法有两种返回方式，一种是 return 语句正常返回，一种是抛出异常。不管哪种返回方式，都会导致栈帧被弹出。也就是说， 栈帧随着方法调用而创建，随着方法结束而销毁。无论方法正常完成还是异常完成都算作方法结束。

程序运行中栈可能会出现两种错误：

- StackOverFlowError： 若栈的内存大小不允许动态扩展，那么当线程请求栈的深度超过当前 Java 虚拟机栈的最大深度的时候，就抛出 StackOverFlowError 错误。
- OutOfMemoryError： 如果栈的内存大小可以动态扩展， 如果虚拟机在动态扩展栈时无法申请到足够的内存空间，则抛出OutOfMemoryError异常。

#### 局部变量表

主要存放了编译期可知的各种数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（reference 类型，它不同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是指向一个代表对象的句柄或其他与此对象相关的位置）。

#### 操作数栈

主要作为方法调用的中转站使用，用于存放方法执行过程中产生的中间计算结果。另外，计算过程中产生的临时变量也会放在操作数栈中。

#### 动态链接

主要服务一个方法需要调用其他方法的场景。在 Java 源文件被编译成字节码文件时，所有的变量和方法引用都作为符号引用（Symbilic Reference）保存在 Class 文件的常量池里。当一个方法要调用其他方法，需要将常量池中指向方法的符号引用转化为其在内存地址中的直接引用。动态链接的作用就是为了将符号引用转换为调用方法的直接引用。

### 本地方法栈

本地方法栈和虚拟机栈的作用类似，区别是虚拟机栈执行的是Java方法，而本地方法栈则执行的是Native方法。在HotSpot虚拟机中本地方法栈和Java虚拟机栈合二为一。

本地方法被执行的时候，在本地方法栈也会创建一个栈帧，用于存放该本地方法的局部变量表、操作数栈、动态链接、出口信息。

方法执行完毕后相应的栈帧也会出栈并释放内存空间，也会出现 StackOverFlowError 和 OutOfMemoryError 两种错误。

### 堆

### 方法区

### 