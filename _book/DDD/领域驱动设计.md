## 软件架构模式的演进

单体架构：采用面向过程的设计方法，系统包括客户端UI层和数据库两层，采用C/S架构模式，整个系统围绕数据库驱动设计和开发，并且总是从设计数据库和字段开始。
集中式架构：采用面向对象的设计方法，系统包括业务接入层、业务逻辑层和数据库层，采用经典的三层架构，也有部分采用传统的SOA架构。这种架构容易使系统变得臃肿，可扩展性和弹性伸缩性差。
分布式微服务架构：随着微服务架构的理念的提出，集中式架构正向分布式微服务架构演进。微服务架构可以很好的实现应用之间的解耦，解决单体应用扩展性和弹性伸缩能力不足的问题。

## 微服务设计的难点

不知道业务或者微服务的边界到底在哪里

## DDD的核心思想
 
通过领域驱动设计的方法定义领域模型，从而确定业务和应用边界，保证业务模型和代码模型的一致性

## DDD为什么适合微服务

DDD是一种处理高度复杂领域的设计思想，它试图分离技术实现的复杂性，并围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解，难以演进的问题。DDD不是架构，而是一种架构设计方法论，它通过边界划分将复杂领域简单化，帮我们设计出清晰的领域和应用边界，可以和容易的实现架构演进。

## DDD包括战略设计和战术设计两部分

战略设计：从业务视角出发，建立业务领域模型，划分领域边界，建立通用预研的限界上下文，限界上下文可以作为微服务设计的参考边界

战术设计：从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现

## DDD如何进行战略设计

DDD战略设计会建立领域模型，领域模型可以用于知道微服务的设计和拆分。事件风暴是建立领域模型的主要方法，它是一个从发散到收敛的过程。它通常采用用例分析、场景分析和用户旅程分析，尽可能全面不遗漏地分解业务领域，并梳理领域对象之间的关系，这是一个发散的过程。事件风暴过程会产生很多的实体、命令、事件等领域对象，我们将这些领域对象从不同的维度进行聚类，行程如聚合、限界上下文等边界，建立领域模型，这就是一个收敛的过程。

## 散步划分领域模型和微服务的边界

第一步：在事件风暴中梳理业务过程中的用户操作、事件以及外部依赖关系等，根据这些要素梳理出领域实体等领域对象

第二步：根据领域实体之间的业务关联性，将业务紧密相关的实体进行组合行成聚合，同时确定聚合中的聚合根、值对象和实体。在这个图中，聚合之间的边界是第一层边界，他们在同一个微服务实例中运行，这个边界是逻辑边界。

第三步：根据业务及语义边界等因素，将一个或者多个聚合划定在一个限界上下文中，行成领域模型。

## DDD和微服务的关系

DDD是一种架构设计方法，微服务是一种架构风格，两者本质上都是为了追求高响应力，而从业务视角去分离应用系统建设复杂度的手段。两者都强调从业务出发，其核心要义是强调根据业务发展，合理划分领域边界，持续调整现有架构，优化现有代码，以保持架构和代码的生命力，也就是我们常说的演进式架构

DDD主要关注：从业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性。

微服务主要关注：运行时的进程间通信、容错和故障隔离，实现去中心化数据管理和去中心化服务治理，关注微服务的独立开发、测试、构建和部署

## DDD名词概念

### 领域
领域是用户确定范围的，范围即边界，这也是DDD在设计中不断强调边界的原因

DDD会按照一定的规则将业务领域进行细分，当领域细分到一定程度后，DDD会将问题限定在也定的边界内，在这个边界内建立领域模型，进而用代码实现该领域模型，解决相应的业务问题，简言之，DDD的领域就是这个边界内要解决的业务问题域

### 子域

领域可以进一步划分为子域。每个子域对应一个更小的问题域或更小的业务范围

### 核心域、通用域和支撑域

在领域不断划分的过程中，领域会细分为不同的子域，子域可以根据自身重要性和功能属性划分为三类子域，它们分别是：核心域、通用域和支撑域

决定产品和公司核心竞争力的子域是核心域，它是业务成功的主要因素和公司的核心竞争力。没有太多个性化的诉求，同时被多个子域使用的通用功能子域是通用域。还有一种功能子域是必须的，但既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的子域，它就是支撑域。

### 通用语言和限界上下文

通用语言定义上下文含义，限界上下文则定义领域边界，以确保每个上下文含义在它特定的边界内都具有唯一的含义，领域模型则存在于这个边界之内。

#### 通用语言

在事件风暴中，通过团队交流达到共识的，能够简单、清晰、准确描述业务涵义和规则的语言就是通用语言。通用语言是团队统一的语言，不管你在团队内承担什么角色，在同一个领域的软件声明周期里都使用统一的语言进行交流

通用语言包含术语和用例成精，并且能够直接反映到代码中。通用语言的名词可以给领域对象命名，如商品、订单等，对应实体对象；而动词则表示一个动作或者事件，如商品已下单、订单已付款等，对应领域事件或者命令

通用预研贯穿DDD的整个设计过程。

#### 限界上下文

限界： 领域的边界
上下文：语义环境

限定上下文：用来封装通用预研和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等有一个确切的含义，没有二义性。这个边界定义了模型的适用范围，使团队所有成员能够明确地知道什么应该在模型中实现，什么不应该在模型中实现

### 实体：

拥有唯一标志符，且标志符在经历各种状态变更后仍能保持一致。对这些对象而言，重要的不是其属性，而是其延续性和标识，对象的延续性和标识会跨越甚至超出软件的生命周期

在战略设计中，实体是领域模型的一个重要对象

领域模型中的实体是多个属性、操作或行为的载体

事件风暴中可以根据命令、操作或者事件，找出产生这些行为的业务实体对象，进而按照一定的业务规则将依存度高的业务关联紧密的多个实体对象和值对象进行聚合

与实体相关的所有业务逻辑都在实体类的方法中实现，跨多个实体的领域逻辑则在领域服务中实现

实体以领域对象(DO)的形式存在，每个实体对象都有唯一的ID。我们可以对一个实体对象进行多次修改，修改后的数据和原来的数据可能会大不相同。但是由于它们拥有相同的ID，依然是同一个实体。比如商品是商品上下文的一个实体，通过唯一的商品ID来标识，不管这个商品的数据如何变化，商品的ID移植保持不变，它始终是一个商品

### 值对象

通过对象属性值来识别的对象，它将多个相关属性组合为一个概念整体，在DDD中用来描述领域的特定方面，并且是一个没有标志符的对象，叫做值对象

值对象描述了领域中的一件东西，这个东西是不可变的，它将不同的相关属性组合成一个概念整体。当度量和描述概念时，可以用另外一个值对象予以替代。它可以和其他的值对象进行相等性比较，且不对对协作对象造成副作用。

值对象本质上是一个集合，用于描述目的、具有整体概念和不可修改的属性


本质上实体是看得到摸得到的实实在在的业务对象，实体具有业务属性、业务行为和业务逻辑
值对象只是若干个属性的集合，只有数据初始化操作和优先的不涉及修改数据的行为，基本不包含业务逻辑。值对象的属性集虽然在物理上独立出来，但在逻辑上仍然是实体属性的一部分，用于描述实体的特征


### 聚合

领域模型内的实体和值对象就好比个体，而能让实体和值对象协同工作的组织就是聚合，它用来确保这些领域对象在实现共同的业务逻辑时，能保证数据的一致性

聚合就是由业务和逻辑紧密的实体和值对象组合而成的，聚合是数据修改和持久化的基本单元，每一个聚合对应一个仓储，实现数据的持久化

聚合有一个聚合根和上下文边界，这个边界根据业务单一职责和高内聚原则，定义了聚合内部应该包含哪些实体和值对象，而聚合之间的边界是松耦合的。

聚合在 DDD 分层架构里属于领域层，领域层包含了多个聚合，共同实现核心业务逻辑。聚合内实体以充血模型实现个体业务能力，以及业务逻辑的高内聚。跨多个实体的业务逻辑通过领域服务来实现，跨多个聚合的业务逻辑通过应用服务来实现。比如有的业务场景需要同一个聚合的 A 和 B 两个实体来共同完成，我们就可以将这段业务逻辑用领域服务来实现；而有的业务逻辑需要聚合 C 和聚合 D 中的两个服务共同完成，这时你就可以用应用服务来组合这两个服务。

### 聚合根

聚合根的主要目的是为了避免由于复杂数据模型缺少统一的业务规则控制，而导致聚合、实体之间数据不一致的问题

传统数据模型中的每一个实体都是对等的，如果任由实体进行无控制地调用和数据修改，很可能会导致实体之间数据逻辑的不一致。而如果采用锁的方式则会增加软件的复杂度，也会降低系统的性能

如果把聚合比作组织，那么聚合根就是这个组织的负责人。聚合根也称为根实体，它不仅仅是实体，还是聚合的管理者
